
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lector tarjetas</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root {
            --primary: #4285F4;
            --correct: #34A853;
            --incorrect: #EA4335;
            --background: #f8f9fa;
        }
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background);
        }
        .header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .container {
            max-width: 100%;
            padding: 0;
        }
        .scanner-section {
            background-color: black;
            position: relative;
            height: 60vh;
            overflow: hidden;
        }
        #scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .scan-frame {
            width: 80%;
            max-width: 350px;
            height: 350px;
            border: 4px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.7);
        }
        .controls {
            padding: 20px;
            background-color: white;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid #eee;
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            flex: 1;
            min-width: 120px;
            transition: all 0.2s;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-secondary {
            background-color: #f1f1f1;
            color: #333;
        }
        .btn-danger {
            background-color: var(--incorrect);
            color: white;
        }
        .btn-success {
            background-color: var(--correct);
            color: white;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        select, input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            flex: 2;
        }
        .questions-panel {
            padding: 15px;
            background-color: white;
            border-bottom: 1px solid #eee;
        }
        .question-tabs {
            display: flex;
            overflow-x: auto;
            gap: 5px;
            margin-bottom: 10px;
        }
        .question-tab {
            padding: 8px 15px;
            background-color: #f1f1f1;
            border-radius: 5px;
            cursor: pointer;
            white-space: nowrap;
        }
        .question-tab.active {
            background-color: var(--primary);
            color: white;
        }
        .results {
            padding: 20px;
        }
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stats-panel {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stats-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        .total .stat-value { color: var(--primary); }
        .correct .stat-value { color: var(--correct); }
        .incorrect .stat-value { color: var(--incorrect); }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        .student-list {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
        }
        .student-card {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        .student-card:last-child {
            border-bottom: none;
        }
        .detected-response {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 28px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 20;
        }
        .detected-response.show {
            opacity: 1;
        }
        .error-message {
            color: var(--incorrect);
            text-align: center;
            padding: 20px;
            display: none;
        }
        .instructions {
            padding: 15px;
            background-color: #e8f0fe;
            border-radius: 10px;
            margin: 15px;
            font-size: 14px;
        }
        .student-stats-container {
            margin-top: 20px;
        }
        .student-stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        .student-stats-table th, .student-stats-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .student-stats-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        .student-stats-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .correct-answer {
            background-color: #e6f7e6;
        }
        .incorrect-answer {
            background-color: #ffebeb;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tabs-header {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 10px;
        }
        .tab-header {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f1f1f1;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab-header.active {
            background-color: var(--primary);
            color: white;
        }
        .scrollable-table {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            flex: 1;
        }
        .file-input-button {
            padding: 12px 20px;
            background-color: #f1f1f1;
            color: #333;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            .stats {
                grid-template-columns: 1fr;
            }
            .export-buttons {
                flex-direction: column;
            }
            .student-stats-table {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Lector Tarjetas</h1>
    </div>
    
    <div class="instructions">
        <p><strong>Instrucciones:</strong> Agrega preguntas con el botón "+" o importa desde CSV. Cambia entre preguntas con las pestañas. Enfoca el código QR dentro del marco.</p>
    </div>
    
    <div class="scanner-section">
        <video id="scanner-video" playsinline></video>
        <canvas id="scanner-canvas" style="display: none;"></canvas>
        <div class="scan-overlay">
            <div class="scan-frame"></div>
        </div>
        <div class="detected-response" id="detected-response"></div>
        <div class="error-message" id="error-message"></div>
    </div>
    
    <div class="questions-panel">
        <div class="question-tabs" id="question-tabs"></div>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="new-question" placeholder="Nombre de la pregunta" style="flex: 3;">
            <button id="add-question" class="btn-primary" style="flex: 1;">+ Agregar Pregunta</button>
            <div class="file-input-container">
                <button class="file-input-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                    </svg>
                    Importar CSV
                </button>
                <input type="file" id="import-questions" class="file-input" accept=".csv">
            </div>
        </div>
    </div>
    
    <div class="controls">
        <select id="correct-answer">
            <option value="A">Respuesta Correcta: A</option>
            <option value="B">Respuesta Correcta: B</option>
            <option value="C">Respuesta Correcta: C</option>
            <option value="D">Respuesta Correcta: D</option>
        </select>
        <button id="start-btn" class="btn-primary">Iniciar Escaneo</button>
        <button id="stop-btn" class="btn-secondary" disabled>Detener</button>
    </div>
    
    <div class="results">
        <div class="stats-container">
            <div class="stats-panel">
                <div class="stats-title">Estadísticas por Pregunta</div>
                <div class="stats">
                    <div class="stat total">
                        <div class="stat-value" id="current-total">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat correct">
                        <div class="stat-value" id="current-correct">0</div>
                        <div class="stat-label">Correctas</div>
                    </div>
                    <div class="stat incorrect">
                        <div class="stat-value" id="current-incorrect">0</div>
                        <div class="stat-label">Incorrectas</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-panel">
                <div class="stats-title">Estadísticas Acumuladas</div>
                <div class="stats">
                    <div class="stat total">
                        <div class="stat-value" id="total-total">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat correct">
                        <div class="stat-value" id="total-correct">0</div>
                        <div class="stat-label">Correctas</div>
                    </div>
                    <div class="stat incorrect">
                        <div class="stat-value" id="total-incorrect">0</div>
                        <div class="stat-label">Incorrectas</div>
                    </div>
                </div>
            </div>
        </div>
        
        <h3>Respuestas Registradas</h3>
        <div class="student-list" id="student-list"></div>
        
        <!-- Nueva sección para estadísticas por estudiante -->
        <div class="student-stats-container">
            <h3>Estadísticas Detalladas</h3>
            
            <div class="tabs-header">
                <div class="tab-header active" data-tab="summary">Resumen</div>
                <div class="tab-header" data-tab="detailed">Detalle por Pregunta</div>
            </div>
            
            <div class="tab-content active" id="summary-tab">
                <table class="student-stats-table">
                    <thead>
                        <tr>
                            <th>Estudiante</th>
                            <th>Total Respuestas</th>
                            <th>Correctas</th>
                            <th>Incorrectas</th>
                            <th>Porcentaje</th>
                            <th>Nota (0-5)</th>
                        </tr>
                    </thead>
                    <tbody id="student-stats-body">
                        <!-- Datos se llenarán dinámicamente -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="detailed-tab">
                <div class="scrollable-table">
                    <table class="student-stats-table">
                        <thead>
                            <tr>
                                <th>Estudiante</th>
                                <!-- Columnas de preguntas se agregarán dinámicamente -->
                            </tr>
                        </thead>
                        <tbody id="detailed-stats-body">
                            <!-- Datos detallados se llenarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="export-buttons">
                <button id="export-all" class="btn-success">Exportar Todo (CSV)</button>
            </div>
        </div>
    </div>

    <script>
        // Elementos del DOM
        const video = document.getElementById('scanner-video');
        const canvas = document.getElementById('scanner-canvas');
        const ctx = canvas.getContext('2d');
        const detectedResponse = document.getElementById('detected-response');
        const errorMessage = document.getElementById('error-message');
        const questionTabs = document.getElementById('question-tabs');
        const newQuestionInput = document.getElementById('new-question');
        const addQuestionBtn = document.getElementById('add-question');
        const exportAllBtn = document.getElementById('export-all');
        const importQuestionsInput = document.getElementById('import-questions');
        
        // Estado de la aplicación
        let scanning = false;
        let questions = [
            { id: 1, name: "Pregunta 1", correctAnswer: "A", responses: {} }
        ];
        let currentQuestionId = 1;
        let lastScanTime = 0;
        
        // Mostrar mensaje de error
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        // Ocultar mensaje de error
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        // Actualizar la interfaz de pestañas
        function updateQuestionTabs() {
            questionTabs.innerHTML = '';
            questions.forEach(question => {
                const tab = document.createElement('div');
                tab.className = `question-tab ${question.id === currentQuestionId ? 'active' : ''}`;
                tab.textContent = question.name;
                tab.dataset.questionId = question.id;
                tab.addEventListener('click', () => {
                    currentQuestionId = parseInt(tab.dataset.questionId);
                    document.getElementById('correct-answer').value = 
                        questions.find(q => q.id === currentQuestionId).correctAnswer;
                    updateQuestionTabs();
                    updateStudentList();
                    updateStats();
                    updateStudentStats();
                    updateDetailedStats();
                });
                questionTabs.appendChild(tab);
            });
        }
        
        // Obtener la pregunta actual
        function getCurrentQuestion() {
            return questions.find(q => q.id === currentQuestionId);
        }
        
        // Calcular estadísticas totales
        function calculateTotalStats() {
            let total = 0;
            let correct = 0;
            
            questions.forEach(question => {
                const responses = Object.values(question.responses);
                total += responses.length;
                correct += responses.filter(r => r.isCorrect).length;
            });
            
            return {
                total: total,
                correct: correct,
                incorrect: total - correct
            };
        }
        
        // Calcular estadísticas por estudiante
        function calculateStudentStats() {
            const studentStats = {};
            
            questions.forEach(question => {
                Object.entries(question.responses).forEach(([studentId, response]) => {
                    if (!studentStats[studentId]) {
                        studentStats[studentId] = {
                            total: 0,
                            correct: 0,
                            incorrect: 0,
                            responses: {}
                        };
                    }
                    
                    studentStats[studentId].total++;
                    if (response.isCorrect) {
                        studentStats[studentId].correct++;
                    } else {
                        studentStats[studentId].incorrect++;
                    }
                    
                    // Guardar respuesta detallada por pregunta
                    studentStats[studentId].responses[question.id] = {
                        answer: response.answer,
                        isCorrect: response.isCorrect,
                        questionName: question.name
                    };
                });
            });
            
            return studentStats;
        }
        
        // Calcular nota sobre 5 (redondeada a 1 decimal)
        function calculateGrade(correct, total) {
            if (total === 0) return 0;
            const grade = (correct / total) * 5;
            return Math.round(grade * 10) / 10; // Redondear a 1 decimal
        }
        
        // Actualizar todas las estadísticas
        function updateStats() {
            // Estadísticas de la pregunta actual
            const currentResponses = Object.values(getCurrentQuestion().responses);
            const currentTotal = currentResponses.length;
            const currentCorrect = currentResponses.filter(r => r.isCorrect).length;
            
            document.getElementById('current-total').textContent = currentTotal;
            document.getElementById('current-correct').textContent = currentCorrect;
            document.getElementById('current-incorrect').textContent = currentTotal - currentCorrect;
            
            // Estadísticas acumuladas
            const totals = calculateTotalStats();
            document.getElementById('total-total').textContent = totals.total;
            document.getElementById('total-correct').textContent = totals.correct;
            document.getElementById('total-incorrect').textContent = totals.incorrect;
        }
        
        // Actualizar estadísticas de estudiantes (resumen)
        function updateStudentStats() {
            const studentStats = calculateStudentStats();
            const tbody = document.getElementById('student-stats-body');
            tbody.innerHTML = '';
            
            Object.entries(studentStats).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).forEach(([studentId, stats]) => {
                const percentage = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
                const grade = calculateGrade(stats.correct, stats.total);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>Estudiante ${studentId}</td>
                    <td>${stats.total}</td>
                    <td>${stats.correct}</td>
                    <td>${stats.incorrect}</td>
                    <td>${percentage}%</td>
                    <td><strong>${grade}</strong></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Actualizar estadísticas detalladas por pregunta
        function updateDetailedStats() {
            const studentStats = calculateStudentStats();
            const tbody = document.getElementById('detailed-stats-body');
            const thead = document.querySelector('#detailed-tab thead tr');
            
            // Limpiar y crear encabezados
            thead.innerHTML = '<th>Estudiante</th>';
            tbody.innerHTML = '';
            
            // Agregar columnas para cada pregunta
            questions.forEach(question => {
                thead.innerHTML += `<th>${question.name} (${question.correctAnswer})</th>`;
            });
            
            // Agregar filas para cada estudiante
            Object.entries(studentStats).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).forEach(([studentId, stats]) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>Estudiante ${studentId}</td>`;
                
                // Agregar celdas para cada pregunta
                questions.forEach(question => {
                    const response = stats.responses[question.id];
                    if (response) {
                        const cellClass = response.isCorrect ? 'correct-answer' : 'incorrect-answer';
                        row.innerHTML += `<td class="${cellClass}">${response.answer}</td>`;
                    } else {
                        row.innerHTML += '<td>-</td>';
                    }
                });
                
                tbody.appendChild(row);
            });
        }
        
        // Actualizar lista de estudiantes
        function updateStudentList() {
            const list = document.getElementById('student-list');
            list.innerHTML = '';
            
            const currentQuestion = getCurrentQuestion();
            const responses = currentQuestion.responses;
            
            Object.entries(responses)
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
                .forEach(([id, data]) => {
                    const card = document.createElement('div');
                    card.className = 'student-card';
                    card.innerHTML = `
                        <div><strong>Estudiante ${id}</strong></div>
                        <div style="color: ${data.isCorrect ? '#34A853' : '#EA4335'}">
                            ${data.answer} (${data.isCorrect ? '✓' : '✗'})
                        </div>
                    `;
                    list.appendChild(card);
                });
        }
        
        // Exportar todos los datos a un solo CSV
        function exportAllToCsv() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // 1. Hoja de respuestas detalladas
            csvContent += "=== RESPUESTAS DETALLADAS ===\n";
            csvContent += "Pregunta,Estudiante,Respuesta,Correcta,FechaHora\n";
            
            questions.forEach(question => {
                Object.entries(question.responses).forEach(([studentId, response]) => {
                    csvContent += `"${question.name}",${studentId},${response.answer},${response.isCorrect ? "Sí" : "No"},"${response.timestamp.toLocaleString()}"\n`;
                });
            });
            
            // 2. Hoja de estadísticas de estudiantes
            const studentStats = calculateStudentStats();
            csvContent += "\n=== ESTADÍSTICAS DE ESTUDIANTES ===\n";
            csvContent += "Estudiante,Total Respuestas,Correctas,Incorrectas,Porcentaje,Nota (0-5)\n";
            
            Object.entries(studentStats).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).forEach(([studentId, stats]) => {
                const percentage = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
                const grade = calculateGrade(stats.correct, stats.total);
                csvContent += `Estudiante ${studentId},${stats.total},${stats.correct},${stats.incorrect},${percentage}%,${grade}\n`;
            });
            
            // 3. Hoja de detalle de respuestas
            csvContent += "\n=== DETALLE DE RESPUESTAS ===\n";
            csvContent += "Estudiante,";
            questions.forEach(question => {
                csvContent += `"${question.name} (${question.correctAnswer})",`;
            });
            csvContent += "\n";
            
            Object.entries(studentStats).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).forEach(([studentId, stats]) => {
                csvContent += `Estudiante ${studentId},`;
                
                questions.forEach(question => {
                    const response = stats.responses[question.id];
                    if (response) {
                        csvContent += `${response.answer} (${response.isCorrect ? "✓" : "✗"}),`;
                    } else {
                        csvContent += "-,";
                    }
                });
                
                csvContent += "\n";
            });
            
            // Crear enlace de descarga
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "datos_plickers_completos.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Iniciar la cámara
        async function startCamera() {
            hideError();
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.play();
                
                video.onplaying = () => {
                    scanning = true;
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;
                    processFrame();
                };
                
                video.onerror = () => {
                    showError('Error al iniciar la cámara. Intenta recargar la página.');
                };
                
            } catch (err) {
                let errorMsg = 'Error al acceder a la cámara: ';
                switch(err.name) {
                    case 'NotAllowedError':
                        errorMsg += 'Permiso denegado. Por favor habilita la cámara en la configuración del navegador.';
                        break;
                    case 'NotFoundError':
                        errorMsg += 'No se encontró cámara trasera.';
                        break;
                    case 'NotReadableError':
                        errorMsg += 'La cámara está siendo usada por otra aplicación.';
                        break;
                    default:
                        errorMsg += err.message;
                }
                showError(errorMsg);
                console.error(err);
            }
        }
        
        // Procesar cada frame del video con detección mejorada
        function processFrame() {
            if (!scanning) return;
            
            // Ajustar canvas al tamaño del video
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (code) {
                    const now = Date.now();
                    if (now - lastScanTime < 1500) {
                        requestAnimationFrame(processFrame);
                        return;
                    }
                    lastScanTime = now;
                    
                    const studentId = code.data;
                    const orientation = Math.atan2(
                        code.location.topRightCorner.y - code.location.topLeftCorner.y,
                        code.location.topRightCorner.x - code.location.topLeftCorner.x
                    );
                    
                    // Detección mejorada que no confunde B/D
                    const degrees = (orientation * (180 / Math.PI) + 360 + 45) % 360; // Añadimos 45° para ajustar
                    const sector = Math.floor(degrees / 90) % 4;
                    const answers = ['A', 'B', 'C', 'D'];
                    const answer = answers[sector];
                    
                    const currentQuestion = getCurrentQuestion();
                    const correctAnswer = currentQuestion.correctAnswer;
                    const isCorrect = answer === correctAnswer;
                    
                    if (!currentQuestion.responses[studentId] || 
                        currentQuestion.responses[studentId].answer !== answer) {
                        
                        currentQuestion.responses[studentId] = {
                            answer: answer,
                            isCorrect: isCorrect,
                            timestamp: new Date()
                        };
                        
                        // Mostrar detección
                        detectedResponse.textContent = `Est. ${studentId}: ${answer}`;
                        detectedResponse.style.color = isCorrect ? '#34A853' : '#EA4335';
                        detectedResponse.classList.add('show');
                        
                        setTimeout(() => {
                            detectedResponse.classList.remove('show');
                        }, 1500);
                        
                        // Actualizar estadísticas
                        updateStats();
                        updateStudentList();
                        updateStudentStats();
                        updateDetailedStats();
                    }
                }
            }
            
            requestAnimationFrame(processFrame);
        }
        
        // Detener la cámara
        function stopCamera() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            scanning = false;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
        }
        
        // Cambiar entre pestañas de estadísticas
        function switchTab(tabId) {
            // Actualizar encabezados de pestañas
            document.querySelectorAll('.tab-header').forEach(header => {
                header.classList.remove('active');
            });
            document.querySelector(`.tab-header[data-tab="${tabId}"]`).classList.add('active');
            
            // Actualizar contenido de pestañas
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }
        
        // Importar preguntas desde CSV
        function importQuestionsFromCSV(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    const newQuestions = [];
                    
                    lines.forEach((line, index) => {
                        // Saltar líneas vacías o la primera línea si es encabezado
                        if (!line.trim() || (index === 0 && (line.includes('pregunta') || line.includes('respuesta')))) {
                            return;
                        }
                        
                        const parts = line.split(',');
                        if (parts.length >= 2) {
                            const questionName = parts[0].trim().replace(/"/g, '');
                            const correctAnswer = parts[1].trim().toUpperCase();
                            
                            if (['A', 'B', 'C', 'D'].includes(correctAnswer)) {
                                newQuestions.push({
                                    id: Date.now() + index, // ID único para cada pregunta
                                    name: questionName,
                                    correctAnswer: correctAnswer,
                                    responses: {}
                                });
                            }
                        }
                    });
                    
                    if (newQuestions.length > 0) {
                        // Agregar las nuevas preguntas
                        questions = questions.concat(newQuestions);
                        currentQuestionId = newQuestions[0].id; // Seleccionar la primera pregunta importada
                        document.getElementById('correct-answer').value = newQuestions[0].correctAnswer;
                        
                        // Actualizar la interfaz
                        updateQuestionTabs();
                        updateStats();
                        updateStudentStats();
                        updateDetailedStats();
                        
                        alert(`Se importaron ${newQuestions.length} preguntas correctamente.`);
                    } else {
                        showError('El archivo CSV no contiene preguntas válidas.');
                    }
                } catch (error) {
                    console.error('Error al procesar el archivo CSV:', error);
                    showError('Error al procesar el archivo CSV. Asegúrate de que el formato sea correcto.');
                }
            };
            
            reader.onerror = function() {
                showError('Error al leer el archivo. Intenta con otro archivo.');
            };
            
            reader.readAsText(file);
        }
        
        // Event Listeners
        document.getElementById('start-btn').addEventListener('click', startCamera);
        document.getElementById('stop-btn').addEventListener('click', stopCamera);
        
        document.getElementById('correct-answer').addEventListener('change', function() {
            const currentQuestion = getCurrentQuestion();
            if (currentQuestion) {
                currentQuestion.correctAnswer = this.value;
                // Recalcular respuestas correctas/incorrectas
                Object.values(currentQuestion.responses).forEach(response => {
                    response.isCorrect = response.answer === this.value;
                });
                updateStats();
                updateStudentList();
                updateStudentStats();
                updateDetailedStats();
            }
        });
        
        addQuestionBtn.addEventListener('click', function() {
            const questionName = newQuestionInput.value.trim() || `Pregunta ${questions.length + 1}`;
            const newQuestion = {
                id: Date.now(),
                name: questionName,
                correctAnswer: "A",
                responses: {}
            };
            questions.push(newQuestion);
            currentQuestionId = newQuestion.id;
            newQuestionInput.value = '';
            updateQuestionTabs();
            document.getElementById('correct-answer').value = "A";
            updateStudentList();
            updateStats();
            updateStudentStats();
            updateDetailedStats();
        });
        
        exportAllBtn.addEventListener('click', exportAllToCsv);
        
        // Event listener para importar preguntas desde CSV
        importQuestionsInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    importQuestionsFromCSV(file);
                } else {
                    showError('Por favor, selecciona un archivo CSV válido.');
                }
                // Limpiar el input para permitir cargar el mismo archivo de nuevo si es necesario
                e.target.value = '';
            }
        });
        
        // Event listeners para cambiar pestañas
        document.querySelectorAll('.tab-header').forEach(header => {
            header.addEventListener('click', () => {
                switchTab(header.dataset.tab);
            });
        });
        
        // Inicializar
        updateQuestionTabs();
        updateStats();
        updateStudentStats();
        updateDetailedStats();
    </script>
</body>
</html>
