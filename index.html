<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Avanzado de Hojas de Respuesta</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.danger {
            background-color: #f44336;
        }
        /* Estilo para las hojas de respuesta */
        .answer-sheet {
            width: 90mm;
            height: 135mm;
            margin: 5px;
            padding: 5mm;
            box-sizing: border-box;
            border: 1px dashed #ccc;
            display: inline-block;
            vertical-align: top;
            position: relative;
        }
        .sheet-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }
        @media print {
            .no-print {
                display: none;
            }
            .sheet-container {
                grid-template-columns: repeat(2, 1fr);
                page-break-after: always;
            }
            .answer-sheet {
                border: 1px solid #000;
                height: 135mm;
                page-break-inside: avoid;
            }
        }
        .header {
            text-align: center;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .student-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 10px;
        }
        .qr-code {
            width: 30px;
            height: 30px;
        }
        .questions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2px;
            font-size: 9px;
        }
        .question {
            display: flex;
            align-items: center;
        }
        .question-number {
            margin-right: 2px;
            min-width: 12px;
        }
        .answer-circle {
            width: 12px;
            height: 12px;
            border: 1px solid #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 1px;
            font-size: 8px;
        }
        /* Estilo para el escáner */
        #scanner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #scanner-video {
            width: 80%;
            max-width: 500px;
        }
        #scanner-canvas {
            display: none;
        }
        /* Estadísticas */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .stats-table th, .stats-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .stats-table th {
            background-color: #f2f2f2;
        }
        .correct {
            background-color: #dff0d8;
        }
        .incorrect {
            background-color: #f2dede;
        }
    </style>
</head>
<body>
    <h1>Sistema Avanzado de Hojas de Respuesta</h1>
    
    <!-- Configuración del examen -->
    <div class="section">
        <h2>Configuración del Examen</h2>
        <label for="exam-title">Título del Examen:</label>
        <input type="text" id="exam-title" value="Examen Final"><br><br>
        
        <label for="total-questions">Número de Preguntas:</label>
        <input type="number" id="total-questions" min="1" value="20"><br><br>
        
        <label>Respuestas Correctas (separadas por comas, ej: A,B,C,D,A...):</label><br>
        <textarea id="correct-answers" rows="3" cols="50">A,B,C,D,A,B,C,D,A,B,C,D,A,B,C,D,A,B,C,D</textarea>
    </div>
    
    <!-- Listado de estudiantes -->
    <div class="section">
        <h2>Listado de Estudiantes</h2>
        <label>Nombres de Estudiantes (uno por línea):</label><br>
        <textarea id="student-names" rows="5" cols="50">Juan Pérez
María García
Carlos López
Ana Martínez</textarea>
    </div>
    
    <!-- Controles principales -->
    <div class="section no-print">
        <button onclick="generateSheets()">Generar Hojas</button>
        <button onclick="window.print()">Imprimir Hojas</button>
        <button class="secondary" onclick="startScanner()">Escanear Respuestas</button>
        <button class="secondary" onclick="showStats()">Mostrar Estadísticas</button>
        <button class="secondary" onclick="exportToCSV()">Exportar a CSV</button>
    </div>
    
    <!-- Contenedor de hojas de respuesta -->
    <div id="sheets-container" class="sheet-container"></div>
    
    <!-- Contenedor del escáner -->
    <div id="scanner-container">
        <video id="scanner-video"></video>
        <canvas id="scanner-canvas"></canvas>
        <button class="danger" onclick="stopScanner()" style="margin-top: 20px;">Detener Escaneo</button>
    </div>
    
    <!-- Sección de estadísticas -->
    <div id="stats-section" class="section" style="display: none;">
        <h2>Estadísticas del Examen</h2>
        <div id="stats-content"></div>
    </div>

    <script>
        // Variables globales
        let examData = {
            title: "",
            totalQuestions: 0,
            correctAnswers: [],
            students: [],
            scannedResults: []
        };
        
        // Inicializar al cargar la página
        window.onload = function() {
            generateSheets();
        };
        
        // Generar hojas de respuesta
        function generateSheets() {
            const container = document.getElementById('sheets-container');
            container.innerHTML = '';
            
            examData.title = document.getElementById('exam-title').value;
            examData.totalQuestions = parseInt(document.getElementById('total-questions').value);
            examData.correctAnswers = document.getElementById('correct-answers').value
                .split(',')
                .map(a => a.trim().toUpperCase())
                .slice(0, examData.totalQuestions);
            
            const studentNames = document.getElementById('student-names').value.split('\n');
            examData.students = studentNames
                .filter(name => name.trim() !== '')
                .map((name, index) => ({
                    id: index + 1,
                    name: name.trim(),
                    qrData: `ESTUDIANTE:${name.trim()}|ID:${index + 1}`
                }));
            
            examData.scannedResults = [];
            
            // Generar una hoja por estudiante
            examData.students.forEach(student => {
                const sheet = document.createElement('div');
                sheet.className = 'answer-sheet';
                
                // Generar QR único
                const qr = qrcode(0, 'L');
                qr.addData(student.qrData);
                qr.make();
                
                sheet.innerHTML = `
                    <div class="header">
                        <strong>${examData.title}</strong>
                    </div>
                    <div class="student-info">
                        <div><strong>Nombre:</strong> ${student.name}</div>
                        <div><strong>ID:</strong> ${student.id}</div>
                        <img class="qr-code" src="${qr.createDataURL(2)}" alt="QR">
                    </div>
                    <div class="questions-grid" id="questions-${student.id}"></div>
                `;
                
                const questionsGrid = sheet.querySelector(`#questions-${student.id}`);
                
                // Generar preguntas
                for (let i = 1; i <= examData.totalQuestions; i++) {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question';
                    
                    questionDiv.innerHTML = `
                        <div class="question-number">${i}.</div>
                        <div class="answer-circle">A</div>
                        <div class="answer-circle">B</div>
                        <div class="answer-circle">C</div>
                        <div class="answer-circle">D</div>
                    `;
                    
                    questionsGrid.appendChild(questionDiv);
                }
                
                container.appendChild(sheet);
            });
        }
        
        // Escanear respuestas
        function startScanner() {
            const scannerContainer = document.getElementById('scanner-container');
            scannerContainer.style.display = 'flex';
            
            const video = document.getElementById('scanner-video');
            const canvas = document.getElementById('scanner-canvas');
            const ctx = canvas.getContext('2d');
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                    
                    function scanFrame() {
                        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                                inversionAttempts: "dontInvert",
                            });
                            
                            if (code) {
                                processScannedSheet(code.data);
                            }
                        }
                        
                        requestAnimationFrame(scanFrame);
                    }
                    
                    scanFrame();
                })
                .catch(function(err) {
                    alert("Error al acceder a la cámara: " + err);
                    stopScanner();
                });
        }
        
        function stopScanner() {
            const scannerContainer = document.getElementById('scanner-container');
            scannerContainer.style.display = 'none';
            
            const video = document.getElementById('scanner-video');
            const stream = video.srcObject;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }
        
        function processScannedSheet(data) {
            // Verificar si ya hemos escaneado esta hoja
            if (examData.scannedResults.some(r => r.qrData === data)) {
                return;
            }
            
            // Aquí iría el código para detectar las respuestas marcadas
            // En un sistema real, usarías OpenCV.js o otra librería para detectar los círculos marcados
            // Por simplicidad, aquí simulamos respuestas aleatorias
            
            const student = examData.students.find(s => s.qrData === data);
            if (!student) return;
            
            // Simular respuestas (en un sistema real, esto vendría del escaneo)
            const answers = [];
            for (let i = 0; i < examData.totalQuestions; i++) {
                const options = ['A', 'B', 'C', 'D'];
                answers.push(options[Math.floor(Math.random() * options.length)]);
            }
            
            // Calcular puntaje
            let score = 0;
            const results = [];
            for (let i = 0; i < examData.totalQuestions; i++) {
                const isCorrect = answers[i] === examData.correctAnswers[i];
                if (isCorrect) score++;
                results.push({
                    question: i + 1,
                    answer: answers[i],
                    correct: examData.correctAnswers[i],
                    isCorrect: isCorrect
                });
            }
            
            // Guardar resultados
            examData.scannedResults.push({
                studentId: student.id,
                studentName: student.name,
                qrData: data,
                answers: answers,
                results: results,
                score: score,
                percentage: (score / examData.totalQuestions * 100).toFixed(2),
                grade: (score / examData.totalQuestions * 5).toFixed(2)
            });
            
            alert(`Hoja escaneada: ${student.name}\nPuntaje: ${score}/${examData.totalQuestions}`);
            stopScanner();
        }
        
        // Mostrar estadísticas
        function showStats() {
            if (examData.scannedResults.length === 0) {
                alert("No hay resultados escaneados aún.");
                return;
            }
            
            const statsContent = document.getElementById('stats-content');
            statsContent.innerHTML = '';
            
            // Estadísticas por pregunta
            const questionStats = Array(examData.totalQuestions).fill(0).map(() => ({
                correct: 0,
                total: 0,
                a: 0, b: 0, c: 0, d: 0
            }));
            
            examData.scannedResults.forEach(result => {
                result.results.forEach((r, i) => {
                    questionStats[i].total++;
                    if (r.isCorrect) questionStats[i].correct++;
                    questionStats[i][r.answer.toLowerCase()]++;
                });
            });
            
            // Crear tabla de estadísticas por pregunta
            let statsHTML = '<h3>Estadísticas por Pregunta</h3>';
            statsHTML += '<table class="stats-table"><tr><th>Pregunta</th><th>% Correctas</th><th>Respuesta Correcta</th><th>A</th><th>B</th><th>C</th><th>D</th></tr>';
            
            questionStats.forEach((stat, i) => {
                const percentage = (stat.correct / stat.total * 100).toFixed(2);
                statsHTML += `<tr>
                    <td>${i + 1}</td>
                    <td>${percentage}%</td>
                    <td>${examData.correctAnswers[i]}</td>
                    <td>${stat.a}</td>
                    <td>${stat.b}</td>
                    <td>${stat.c}</td>
                    <td>${stat.d}</td>
                </tr>`;
            });
            
            statsHTML += '</table>';
            
            // Resultados por estudiante
            statsHTML += '<h3>Resultados por Estudiante</h3>';
            statsHTML += '<table class="stats-table"><tr><th>ID</th><th>Nombre</th><th>Puntaje</th><th>Porcentaje</th><th>Nota (0-5)</th></tr>';
            
            examData.scannedResults.forEach(result => {
                statsHTML += `<tr>
                    <td>${result.studentId}</td>
                    <td>${result.studentName}</td>
                    <td>${result.score}/${examData.totalQuestions}</td>
                    <td>${result.percentage}%</td>
                    <td>${result.grade}</td>
                </tr>`;
            });
            
            statsHTML += '</table>';
            
            statsContent.innerHTML = statsHTML;
            document.getElementById('stats-section').style.display = 'block';
        }
        
        // Exportar a CSV
        function exportToCSV() {
            if (examData.scannedResults.length === 0) {
                alert("No hay resultados escaneados para exportar.");
                return;
            }
            
            // Preparar datos para CSV
            const csvData = [];
            
            // Encabezados
            const headers = ['ID', 'Nombre', 'Puntaje', 'Porcentaje', 'Nota (0-5)'];
            for (let i = 1; i <= examData.totalQuestions; i++) {
                headers.push(`P${i}`);
            }
            csvData.push(headers);
            
            // Datos de cada estudiante
            examData.scannedResults.forEach(result => {
                const row = [
                    result.studentId,
                    result.studentName,
                    `${result.score}/${examData.totalQuestions}`,
                    `${result.percentage}%`,
                    result.grade,
                    ...result.answers
                ];
                csvData.push(row);
            });
            
            // Convertir a CSV
            const csv = Papa.unparse(csvData);
            
            // Descargar archivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `resultados_${examData.title.replace(/\s+/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
